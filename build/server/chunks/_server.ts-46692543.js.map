{"version":3,"file":"_server.ts-46692543.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/auth/_username_/verify-registration/_server.ts.js"],"sourcesContent":["import { j as json } from \"../../../../../../chunks/index.js\";\nimport { p as prisma } from \"../../../../../../chunks/prisma.js\";\nimport { verifyRegistrationResponse } from \"@simplewebauthn/server\";\nimport { O as ORIGIN, R as RPID } from \"../../../../../../chunks/private.js\";\nconst POST = async ({ params, request, cookies }) => {\n  const user_name = params.username;\n  const body = await request.json();\n  if (!user_name) {\n    return new Response(JSON.stringify({ error: \"Invalid Request\" }), { status: 400 });\n  }\n  const user = await prisma.user.findFirst({\n    where: {\n      username: user_name\n    }\n  });\n  if (!user) {\n    return new Response(JSON.stringify({ error: \"Invalid user\" }), { status: 400 });\n  }\n  const expectedChallenge = user.currentChallenge;\n  if (!expectedChallenge) {\n    return new Response(JSON.stringify({ error: \"Invalid challenge\" }), { status: 400 });\n  }\n  let verification;\n  try {\n    verification = await verifyRegistrationResponse({\n      response: body,\n      expectedChallenge,\n      expectedOrigin: ORIGIN,\n      expectedRPID: RPID\n    });\n  } catch (error) {\n    console.error(error);\n    return new Response(JSON.stringify({ error }), { status: 400 });\n  }\n  if (verification.registrationInfo && verification.verified) {\n    const session_id = await prisma.session.create({\n      data: {\n        user: {\n          connect: {\n            id: user.id\n          }\n        },\n        expiresAt: new Date((/* @__PURE__ */ new Date()).getTime() + 1e3 * 60 * 60 * 24 * 30)\n        // 30 days\n      }\n    });\n    cookies.set(\"session_id\", session_id.id, {\n      path: \"/\",\n      maxAge: 60 * 60 * 24 * 30,\n      // 30 days\n      httpOnly: true,\n      sameSite: \"strict\"\n    });\n    await prisma.authenticator.create({\n      data: {\n        credentialPublicKey: Buffer.from(verification.registrationInfo.credentialPublicKey),\n        credentialID: Buffer.from(verification.registrationInfo.credentialID),\n        counter: verification.registrationInfo.counter,\n        credentialDeviceType: verification.registrationInfo.credentialDeviceType,\n        credentialBackedUp: verification.registrationInfo.credentialBackedUp,\n        userID: user.id\n      }\n    });\n  }\n  return json(verification);\n};\nexport {\n  POST\n};\n"],"names":[],"mappings":"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"}